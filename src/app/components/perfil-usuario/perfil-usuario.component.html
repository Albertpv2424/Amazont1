<div class="perfil-usuario-container" [ngClass]="{'dark-mode': isDarkMode}">
  <div class="perfil-card">
    <h2 class="perfil-title">Mi Perfil</h2>
    
    <!-- Pestañas de navegación -->
    <div class="perfil-tabs">
      <button class="tab-btn" [ngClass]="{'active': tabSeleccionado === 0}" (click)="cambiarTab(0)">Información Personal</button>
      <button class="tab-btn" [ngClass]="{'active': tabSeleccionado === 1}" (click)="cambiarTab(1)">Pedidos</button>
      <button class="tab-btn" [ngClass]="{'active': tabSeleccionado === 2}" (click)="cambiarTab(2)">Métodos de Pago</button>
      <button class="tab-btn" [ngClass]="{'active': tabSeleccionado === 3}" (click)="cambiarTab(3)">Seguridad</button>
    </div>
    
    <!-- Sección de información personal -->
    <div class="tab-content" *ngIf="tabSeleccionado === 0">
      <form [formGroup]="perfilForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input id="nombre" formControlName="nombre" [ngClass]="{'is-invalid': submitted && f['nombre'].errors}">
          <div *ngIf="submitted && f['nombre'].errors" class="error-message">
            <div *ngIf="f['nombre'].errors['required']">El nombre es obligatorio</div>
            <div *ngIf="f['nombre'].errors['minlength']">Mínimo 3 caracteres</div>
          </div>
        </div>
        <div class="form-group">
          <label for="email">Correo electrónico</label>
          <input id="email" formControlName="email" [ngClass]="{'is-invalid': submitted && f['email'].errors}">
          <div *ngIf="submitted && f['email'].errors" class="error-message">
            <div *ngIf="f['email'].errors['required']">El correo es obligatorio</div>
            <div *ngIf="f['email'].errors['email']">Correo no válido</div>
          </div>
        </div>
        <div class="form-group">
          <label for="telefono">Teléfono</label>
          <input id="telefono" formControlName="telefono" [ngClass]="{'is-invalid': submitted && f['telefono'].errors}">
          <div *ngIf="submitted && f['telefono'].errors" class="error-message">
            <div *ngIf="f['telefono'].errors['pattern']">Debe tener 9 dígitos</div>
          </div>
        </div>
        <div class="form-group">
          <label for="ciudad">Ciudad</label>
          <input id="ciudad" formControlName="ciudad">
        </div>
        <div class="form-group">
          <label for="pais">País</label>
          <input id="pais" formControlName="pais">
        </div>
        <button type="submit" class="btn-guardar">Guardar cambios</button>
      </form>
    </div>
    
    <!-- Sección de historial de pedidos -->
    <div class="tab-content" *ngIf="tabSeleccionado === 1">
      <h3 class="section-title">Historial de pedidos</h3>
      <div class="pedidos-container">
        <table class="pedidos-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pedido of pedidos">
              <td>{{ pedido.id }}</td>
              <td>{{ pedido.fecha }}</td>
              <td>{{ pedido.total | currency:'EUR' }}</td>
              <td>
                <span class="estado-badge" [ngClass]="{'entregado': pedido.estado === 'Entregado', 'en-camino': pedido.estado === 'En camino'}">
                  {{ pedido.estado }}
                </span>
              </td>
              <td><button class="btn-detalle" (click)="verDetallesPedido(pedido.id)">Ver detalles</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Sección de métodos de pago -->
    <div class="tab-content" *ngIf="tabSeleccionado === 2">
      <h2>Mètodes de Pagament</h2>
      <p>Selecciona un mètode de pagament</p>
      
      <!-- Display existing payment methods -->
      <div class="metodos-lista" *ngIf="metodosPago && metodosPago.length > 0">
        <div class="metodo-item" *ngFor="let metodo of metodosPago; let i = index">
          <div class="metodo-info">
            <div class="metodo-tipo">{{ metodo.tipo }}</div>
            <div class="metodo-numero">{{ metodo.numero }}</div>
            <div class="metodo-titular">{{ metodo.titular }}</div>
            <div class="metodo-fecha" *ngIf="metodo.fechaExpiracion">Exp: {{ metodo.fechaExpiracion }}</div>
          </div>
          <button class="btn-eliminar" (click)="eliminarMetodoPago(i)">Eliminar</button>
        </div>
      </div>
      
      <!-- Message if no payment methods -->
      <div class="no-metodos" *ngIf="!metodosPago || metodosPago.length === 0">
        <p>No tienes métodos de pago guardados</p>
      </div>
      
      <!-- Button to add new payment method -->
      <button class="btn-nuevo-metodo" (click)="mostrarFormularioMetodoPago()">
        Afegir nou mètode
      </button>
      
      <!-- Form to add payment method -->
      <form [formGroup]="metodoPagoForm" (ngSubmit)="agregarMetodoPago()" *ngIf="mostrarFormMetodoPago" class="form-metodo-pago">
        <h3>Nuevo método de pago</h3>
        
        <div class="form-group">
          <label for="tipo">Tipo</label>
          <select id="tipo" formControlName="tipo">
            <option value="Tarjeta">Tarjeta de crédito</option>
            <option value="PayPal">PayPal</option>
            <option value="Transferencia">Transferencia bancaria</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="numero">Número</label>
          <input id="numero" formControlName="numero" placeholder="1234 5678 9012 3456">
          <div *ngIf="metodoPagoSubmitted && mp['numero'].errors" class="error-message">
            <div *ngIf="mp['numero'].errors['required']">El número es obligatorio</div>
            <div *ngIf="mp['numero'].errors['pattern']">Debe tener 16 dígitos</div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="titular">Titular</label>
          <input id="titular" formControlName="titular">
          <div *ngIf="metodoPagoSubmitted && mp['titular'].errors" class="error-message">
            <div *ngIf="mp['titular'].errors['required']">El titular es obligatorio</div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="fechaExpiracion">Fecha de expiración</label>
          <input id="fechaExpiracion" formControlName="fechaExpiracion" placeholder="MM/YY">
          <div *ngIf="metodoPagoSubmitted && mp['fechaExpiracion'].errors" class="error-message">
            <div *ngIf="mp['fechaExpiracion'].errors['required']">La fecha es obligatoria</div>
            <div *ngIf="mp['fechaExpiracion'].errors['pattern']">Formato inválido (MM/YY)</div>
          </div>
        </div>
        
        <div class="form-buttons">
          <button type="submit" class="btn-guardar">Guardar</button>
          <button type="button" class="btn-cancelar" (click)="ocultarFormularioMetodoPago()">Cancelar</button>
        </div>
      </form>
    </div>
    
    <!-- Sección de seguridad - Make sure this only shows when tabSeleccionado === 3 -->
    <div class="tab-content" *ngIf="tabSeleccionado === 3">
      <h3 class="section-title">Configuración de cuenta y seguridad</h3>
      <div class="seguridad-container">
        <div class="seguridad-opcion">
          <div class="seguridad-info">
            <h4>Cambiar contraseña</h4>
            <p>Actualiza tu contraseña para mantener tu cuenta segura</p>
          </div>
          <button class="btn-cambiar" (click)="cambiarPassword()">Modificar contraseña</button>
        </div>
        <div class="seguridad-opcion">
          <div class="seguridad-info">
            <h4>Verificación en dos pasos</h4>
            <p>Añade una capa extra de seguridad a tu cuenta</p>
          </div>
          <button class="btn-activar">Activar</button>
        </div>
        <div class="seguridad-opcion">
          <div class="seguridad-info">
            <h4>Sesiones activas</h4>
            <p>Gestiona los dispositivos conectados a tu cuenta</p>
          </div>
          <button class="btn-ver">Ver sesiones</button>
        </div>
      </div>
    </div>
    
    <!-- Remove or comment out any duplicate security section that might be here -->
    <!-- 
    <div class="tab-content" style="display: none;">
      <h3 class="section-title">Configuración de cuenta y seguridad</h3>
      ...
    </div>
    -->
  </div>
</div>