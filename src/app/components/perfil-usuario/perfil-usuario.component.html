<div class="perfil-usuario-container" [ngClass]="{'dark-mode': isDarkMode}">
  <div class="perfil-card">
    <h2 class="perfil-title">Mi Perfil</h2>
    
    <!-- Pestañas de navegación -->
    <div class="perfil-tabs">
      <button class="tab-btn" [ngClass]="{'active': tabSeleccionado === 0}" (click)="cambiarTab(0)">Información Personal</button>
      <button class="tab-btn" [ngClass]="{'active': tabSeleccionado === 1}" (click)="cambiarTab(1)">Pedidos</button>
      <button class="tab-btn" [ngClass]="{'active': tabSeleccionado === 2}" (click)="cambiarTab(2)">Métodos de Pago</button>
      <button class="tab-btn" [ngClass]="{'active': tabSeleccionado === 3}" (click)="cambiarTab(3)">Seguridad</button>
    </div>
    
    <!-- Sección de información personal -->
    <div class="tab-content" *ngIf="tabSeleccionado === 0">
      <form [formGroup]="perfilForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input id="nombre" formControlName="nombre" [ngClass]="{'is-invalid': submitted && f['nombre'].errors}">
          <div *ngIf="submitted && f['nombre'].errors" class="error-message">
            <div *ngIf="f['nombre'].errors['required']">El nombre es obligatorio</div>
            <div *ngIf="f['nombre'].errors['minlength']">Mínimo 3 caracteres</div>
          </div>
        </div>
        <div class="form-group">
          <label for="email">Correo electrónico</label>
          <input id="email" formControlName="email" [ngClass]="{'is-invalid': submitted && f['email'].errors}">
          <div *ngIf="submitted && f['email'].errors" class="error-message">
            <div *ngIf="f['email'].errors['required']">El correo es obligatorio</div>
            <div *ngIf="f['email'].errors['email']">Correo no válido</div>
          </div>
        </div>
        <div class="form-group">
          <label for="telefono">Teléfono</label>
          <input id="telefono" formControlName="telefono" [ngClass]="{'is-invalid': submitted && f['telefono'].errors}">
          <div *ngIf="submitted && f['telefono'].errors" class="error-message">
            <div *ngIf="f['telefono'].errors['pattern']">Debe tener 9 dígitos</div>
          </div>
        </div>
        <div class="form-group">
          <label for="ciudad">Ciudad</label>
          <input id="ciudad" formControlName="ciudad">
        </div>
        <div class="form-group">
          <label for="pais">País</label>
          <input id="pais" formControlName="pais">
        </div>
        <button type="submit" class="btn-guardar">Guardar cambios</button>
      </form>
    </div>
    
    <!-- Sección de historial de pedidos -->
    <div class="tab-content" *ngIf="tabSeleccionado === 1">
      <h3 class="section-title">Historial de pedidos</h3>
      <div class="pedidos-container">
        <table class="pedidos-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pedido of pedidos">
              <td>{{ pedido.id }}</td>
              <td>{{ pedido.fecha }}</td>
              <td>{{ pedido.total | currency:'EUR' }}</td>
              <td>
                <span class="estado-badge" [ngClass]="{'entregado': pedido.estado === 'Entregado', 'en-camino': pedido.estado === 'En camino'}">
                  {{ pedido.estado }}
                </span>
              </td>
              <td><button class="btn-detalle" (click)="verDetallesPedido(pedido.id)">Ver detalles</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Sección de métodos de pago -->
    <div class="tab-content" *ngIf="tabSeleccionado === 2">
      <h2>Métodos de Pago</h2>
      <p>Selecciona un método de pago</p>
      
      <!-- Display existing payment methods -->
      <div class="metodos-lista" *ngIf="metodosPago && metodosPago.length > 0">
        <div class="metodo-item" *ngFor="let metodo of metodosPago; let i = index">
          <div class="metodo-info">
            <div class="metodo-tipo">{{ metodo.tipo }}</div>
            <!-- Mostrar informació específica segons el tipus de pagament -->
            <ng-container *ngIf="metodo.tipo === 'Tarjeta'">
              <div class="metodo-numero">{{ metodo.numero }}</div>
              <div class="metodo-titular">{{ metodo.titular }}</div>
              <div class="metodo-fecha" *ngIf="metodo.fechaExpiracion">Exp: {{ metodo.fechaExpiracion }}</div>
            </ng-container>
            <ng-container *ngIf="metodo.tipo === 'PayPal'">
              <div class="metodo-correo">{{ metodo.correoPaypal }}</div>
            </ng-container>
            <ng-container *ngIf="metodo.tipo === 'Transferencia'">
              <div class="metodo-cuenta">{{ metodo.numeroCuenta }}</div>
              <div class="metodo-entidad">{{ metodo.entidadBancaria }}</div>
            </ng-container>
          </div>
          <button class="btn-eliminar" (click)="eliminarMetodoPago(i)">Eliminar</button>
        </div>
      </div>
      
      <!-- Message if no payment methods -->
      <div class="no-metodos" *ngIf="!metodosPago || metodosPago.length === 0">
        <p>No tienes métodos de pago guardados</p>
      </div>
      
      <!-- Button to add new payment method -->
      <button class="btn-nuevo-metodo" (click)="mostrarFormularioMetodoPago()">
        Añadir nuevo método
      </button>
      
      <!-- Form to add payment method -->
      <form [formGroup]="metodoPagoForm" (ngSubmit)="agregarMetodoPago()" *ngIf="mostrarFormMetodoPago" class="form-metodo-pago">
        <h3>Nuevo método de pago</h3>
        
        <div class="form-group">
          <label for="tipo">Tipo</label>
          <select id="tipo" formControlName="tipo" class="form-control" (change)="onTipoPagoChange($event)">
            <option value="Tarjeta">Tarjeta de crédito</option>
            <option value="PayPal">PayPal</option>
            <option value="Transferencia">Transferencia bancaria</option>
          </select>
        </div>
        
        <!-- Camps per a targeta de crèdit -->
        <div *ngIf="metodoPagoForm.get('tipo')?.value === 'Tarjeta'">
          <div class="form-group">
            <label for="numero">Número de tarjeta</label>
            <input type="text" id="numero" formControlName="numero" class="form-control" placeholder="1234 5678 9012 3456">
            <div *ngIf="metodoPagoSubmitted && mp['numero'].errors" class="text-danger">
              <div *ngIf="mp['numero'].errors['required']">El número de tarjeta es obligatorio</div>
              <div *ngIf="mp['numero'].errors['pattern']">El número de tarjeta debe tener 16 dígitos</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="titular">Titular</label>
            <input type="text" id="titular" formControlName="titular" class="form-control">
            <div *ngIf="metodoPagoSubmitted && mp['titular'].errors" class="text-danger">
              <div *ngIf="mp['titular'].errors['required']">El titular és obligatori</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="fechaExpiracion">Data de caducitat (MM/YY)</label>
            <input type="text" id="fechaExpiracion" formControlName="fechaExpiracion" class="form-control" placeholder="MM/YY">
            <div *ngIf="metodoPagoSubmitted && mp['fechaExpiracion'].errors" class="text-danger">
              <div *ngIf="mp['fechaExpiracion'].errors['required']">La data de caducitat és obligatòria</div>
              <div *ngIf="mp['fechaExpiracion'].errors['pattern']">Format incorrecte. Utilitza MM/YY</div>
            </div>
          </div>
        </div>
        
        <!-- Camps per a PayPal -->
        <div *ngIf="metodoPagoForm.get('tipo')?.value === 'PayPal'">
          <div class="form-group">
            <label for="correoPaypal">Correu electrònic de PayPal</label>
            <input type="email" id="correoPaypal" formControlName="correoPaypal" class="form-control">
            <div *ngIf="metodoPagoSubmitted && mp['correoPaypal']?.errors" class="text-danger">
              <div *ngIf="mp['correoPaypal']?.errors?.['required']">El correu electrònic és obligatori</div>
              <div *ngIf="mp['correoPaypal']?.errors?.['email']">Format de correu electrònic incorrecte</div>
            </div>
          </div>
        </div>
        
        <!-- Camps per a Transferència bancària -->
        <div *ngIf="metodoPagoForm.get('tipo')?.value === 'Transferencia'">
          <div class="form-group">
            <label for="numeroCuenta">Número de cuenta</label>
            <input type="text" id="numeroCuenta" formControlName="numeroCuenta" class="form-control">
            <div *ngIf="metodoPagoSubmitted && mp['numeroCuenta']?.errors" class="text-danger">
              <div *ngIf="mp['numeroCuenta']?.errors?.['required']">El número de cuenta es obligatorio</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="entidadBancaria">Entidad bancaria</label>
            <input type="text" id="entidadBancaria" formControlName="entidadBancaria" class="form-control">
            <div *ngIf="metodoPagoSubmitted && mp['entidadBancaria']?.errors?.['required']">La entidad bancaria es obligatoria</div>
          </div>
        </div>
        
        <div class="form-buttons">
          <button type="submit" class="btn-guardar">Guardar</button>
          <button type="button" class="btn-cancelar" (click)="ocultarFormularioMetodoPago()">Cancelar</button>
        </div>
      </form>
    </div>
    
    <!-- Sección de seguridad - Make sure this only shows when tabSeleccionado === 3 -->
    <div class="tab-content" *ngIf="tabSeleccionado === 3">
      <h3 class="section-title">Configuración de cuenta y seguridad</h3>
      <div class="seguridad-container">
        <div class="seguridad-opcion">
          <div class="seguridad-info">
            <h4>Cambiar contraseña</h4>
            <p>Actualiza tu contraseña para mantener tu cuenta segura</p>
          </div>
          <button class="btn-modificar" (click)="mostrarFormularioPassword()">Modificar contraseña</button>
        </div>       
      </div>
    </div>
    

  </div>
</div>

<div class="form-container" *ngIf="mostrarFormPassword" [ngClass]="{'dark-mode': isDarkMode}">
  <form [formGroup]="passwordForm" (ngSubmit)="cambiarPassword()">
    <div class="form-group">
      <label for="currentPassword">Contraseña actual:</label>
      <input type="password" id="currentPassword" formControlName="currentPassword">
      <div *ngIf="passwordSubmitted && p_form['currentPassword'].errors" class="error-message">
        <span *ngIf="p_form['currentPassword'].errors['required']">La contraseña actual es obligatoria</span>
      </div>
    </div>

    <div class="form-group">
      <label for="newPassword">Nueva contraseña:</label>
      <input type="password" id="newPassword" formControlName="newPassword">
      <div *ngIf="passwordSubmitted && p_form['newPassword'].errors" class="error-message">
        <span *ngIf="p_form['newPassword'].errors['required']">La nueva contraseña es obligatoria</span>
        <span *ngIf="p_form['newPassword'].errors['minlength']">La contraseña debe tener al menos 6 caracteres</span>
      </div>
    </div>

    <div class="form-group">
      <label for="confirmPassword">Confirmar nueva contraseña:</label>
      <input type="password" id="confirmPassword" formControlName="confirmPassword">
      <div *ngIf="passwordSubmitted && p_form['confirmPassword'].errors" class="error-message">
        <span *ngIf="p_form['confirmPassword'].errors['required']">La confirmación de la contraseña es obligatoria</span>
        <span *ngIf="p_form['confirmPassword'].errors['passwordMismatch']">Las contraseñas no coinciden</span>
      </div>
    </div>

    <div *ngIf="passwordError" class="error-message">
      {{ passwordError }}
    </div>

    <div *ngIf="passwordSuccess" class="success-message">
      {{ passwordSuccess }}
    </div>

    <div class="button-group">
      <button type="submit" class="btn-guardar">Guardar canvis</button>
      <button type="button" class="btn-cancelar" (click)="ocultarFormularioPassword()">Cancel·lar</button>
    </div>
  </form>
</div>